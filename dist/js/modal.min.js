!function(a,b,c,d){function e(b,c){this.el=b,this.$el=a(this.el),this.options=a.extend({},h,c);var d,e=this.$el.data(this.options.dataOptName);e&&(this.options=a.extend({},this.options,e)),d="."+a.trim(this.options.evtNamespace),this.options.showEvent="click"===this.options.showEvent?"click"+d:"mouseover"+d,this._name=f,this.init()}var f="allyModal",g=!1,h={overlayClass:"ally-overlay",overlayModifier:"",overlayAttrs:"",modalClass:"modal",modalModifier:"",modalAttrs:"",dataOptName:"modal-options",contentType:"image",contentClass:"content",contentModifier:"",contentAttrs:"",modalTemplate:null,customContent:null,ajaxSettings:{},ajaxContext:null,showClass:"show",showEvent:"click",evtNamespace:"ally.modal",closeBtnContent:"Close",closeBtnClass:"close-btn",closeBtnAttrs:"data-close-modal",closeModal:"[data-close-modal]",clickOutsideToHide:!0,isOpen:!1,autoShow:!1,keepClosedId:!1,closedDuration:30,modalUrl:null,ie8Center:!0,onCreate:a.noop,onOpen:a.noop,onClose:a.noop},i=function(b){return"object"==typeof a(b).data("plugin_"+f)},j=function(){Date.now=Date.now||function(){return+new Date};var a=JSON.parse(localStorage.getItem("allyModal"));if(currentDate=Date.now(),a&&a.keepClosed)for(var b in a.keepClosed)a.keepClosed.hasOwnProperty(b)&&a.keepClosed[b]<=currentDate&&(delete a.keepClosed[b],a=JSON.stringify(a),localStorage.setItem("allyModal",a))},k=function(b){b.keyCode&&27!==b.keyCode||a(':modalPlugin("isOpen")')[f]("hide",[!1,!0])},l=function(){b.history.location||b.location;a(c).on("keyup",k),j(),a(b).on("popstate.modal.history",function(){a(':modalPlugin("isOpen")')[f]("hide"),history.state&&history.state.modal&&a(':modalUrl("'+history.state.modal+'")')[f]("show")})},m=function(a){if(isNaN(parseInt(a,10)))switch(a){case"null":return null;case"true":return!0;case"false":return!1;case"undefined":return d;default:return a}return parseInt(a,10)};l(),a.extend(a.expr[":"],{modalPlugin:function(b,c,d){if(d[3]&&i(b)){var e=d[3].split(":"),g=a.data(b,"plugin_"+f).options[e[0]];return e.length>1?g===m(e[1]):g}return i(b)},modalUrl:function(b,c,d){if(i(b)){var e=a.data(b,"plugin_"+f).options.modalUrl;return d[3]?e===d[3]:"undefined"!=typeof e}return!1}}),e.prototype={init:function(){this.buildModal()},showConditions:function(){var a=b.location.hash,c=this.options.modalUrl,d=JSON.parse(localStorage.getItem("allyModal")),e=d&&d.keepClosed&&d.keepClosed.hasOwnProperty(this.options.keepClosedId);return c&&a.split("#")[1]===c||this.options.autoShow&&""===a&&!e},processCustomTemplate:function(b){this.$overlay=a(b).addClass(this.options.overlayModifier),this.$modal=this.$overlay.find("."+this.options.modalClass).addClass(this.options.modalModifier),this.$content=this.$overlay.find("."+this.options.contentClass).addClass(this.options.contentModifier),this.$closeBtn=this.$overlay.find("."+this.options.closeBtnClass)},buildContent:function(){var b=this.getContent(),c=this;"function"==typeof b.success?b.done(function(b){var d;c.options.ajaxContext?(d=a(b).find(c.options.ajaxContext),d.length<1&&(d=a(b).filter(c.options.ajaxContext))):d=b,c.$content.append(d)}).fail(function(){c.$content.append("<p>Request Failed</p>")}):c.$content.append(b)},buildModal:function(){"inline"===this.options.contentType?this.processCustomTemplate(this.$el.attr("href")):(this.options.modalTemplate?(this.processCustomTemplate(this.options.modalTemplate),a("body").append(this.$overlay)):(this.$overlay=a('<div class="'+a.trim(this.options.overlayClass+" "+this.options.overlayModifier)+'" '+this.options.overlayAttrs+"></div>"),this.$modal=a('<div class="'+a.trim(this.options.modalClass+" "+this.options.modalModifier)+'" '+this.options.modalAttrs+"></div>"),this.$content=a('<div class="'+a.trim(this.options.contentClass+" "+this.options.contentModifier)+'" '+this.options.contentAttrs+"></div>"),this.$closeBtn=a('<a href="#" class="'+this.options.closeBtnClass+'" '+this.options.closeBtnAttrs+">"+this.options.closeBtnContent+"</a>"),a("body").append(this.$overlay.append(this.$modal.append([this.$closeBtn,this.$content])))),this.buildContent()),this.attachEvents(),this.showConditions()&&this.show(),this.options.onCreate()},attachEvents:function(){this.$el.on(this.options.showEvent,{self:this},this.show),this.$overlay.on("click",this.options.closeModal,{self:this},this.hide),this.options.clickOutsideToHide&&this.$overlay.on("click",{self:this},this.overlayHide)},getContent:function(){var b=this.$el.attr("href");switch(this.options.contentType){case"image":return a("<img>",{src:b});case"iframe":return a("<iframe>",{src:b});case"ajax":var c=a.extend({url:b},this.options.ajaxSettings);return a.ajax(c);case"custom":default:return this.options.customContent}},storeClosed:function(){var a,b=JSON.parse(localStorage.getItem("allyModal")),c=(this.options.keepClosedId,new Date),d=(new Date).setDate(c.getDate()+this.options.closedDuration);b||(b={keepClosed:{}}),b.keepClosed[this.options.keepClosedId]=d,a=JSON.stringify(b),localStorage.setItem("allyModal",a)},centerInIE8:function(){var c=a(b),d=(c.width()-this.$modal.width())/2,e=(c.height()-this.$modal.height())/2;this.$modal.css({left:d,top:e})},show:function(b){var c=b?b.data.self:this;a(':modalPlugin("isOpen")')[f]("hide"),b&&(b.preventDefault(),c.options.modalUrl&&history.pushState({modal:c.options.modalUrl},null,"#"+c.options.modalUrl)),c.options.onOpen(),c.$overlay.addClass(c.options.showClass),c.options.isOpen=!0,g&&c.options.ie8Center&&c.centerInIE8()},hide:function(a,c){var d=a?a.data.self:this;(a||c)&&(a&&a.preventDefault(),d.options.modalUrl&&(history.state?history.go(-1):history.replaceState(null,null,b.location.pathname))),d.options.keepClosedId&&d.storeClosed(),d.options.onClose(),d.$overlay.removeClass(d.options.showClass),d.options.isOpen=!1},overlayHide:function(a){a.preventDefault();var b=a.data.self;a.target===b.$overlay[0]&&b.hide(a)},destroy:function(){a(b).off("popstate.modal.history"),this.$el.off(this.options.showEvent),this.$overlay.remove()},create:function(){this.init()}},a.fn[f]=function(b,c){return this.each(function(){if(a.data(this,"plugin_"+f)){if(a.isFunction(e.prototype[b])&&b.indexOf("_")<0){var d=a.data(this,"plugin_"+f);c=c||[],d[b].apply(d,c)}}else a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);